<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Assistant IA mobile intelligent et s√©curis√©">
    <title>Chat IA Mobile</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="glass-neon-styles.css">
    <style>
        /* Styles inline suppl√©mentaires si n√©cessaire - tout est dans glass-neon-styles.css */
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-top">
                <div class="chat-title">ü§ñ Assistant IA</div>
            </div>
            <div class="header-controls-row">
                <div class="header-controls">
                    <button class="header-btn" id="gamesBtn" title="Jeux">üéÆ</button>
                    <button class="header-btn" id="settingsBtn" title="Param√®tres">‚öôÔ∏è</button>
                    <button class="header-btn" id="databaseBtn" title="Base de donn√©es">üíæ</button>
                    <button class="header-btn" id="serverBtn" title="Serveurs">üåê</button>
                    <button class="header-btn" id="kittBtn" title="Interface KITT">üöó</button>
                    <button class="header-btn" id="infoBtn" title="Informations">‚ÑπÔ∏è</button>
                    <button class="header-btn" id="langBtn" title="Langue">üåç</button>
                    <button class="header-btn" id="clearBtn" title="Effacer">üóëÔ∏è</button>
                </div>
            </div>
            <div class="personality-selector">
                <button class="personality-btn active" data-personality="casual">üòä D√©contract√©</button>
                <button class="personality-btn" data-personality="friendly">ü§ù Amical</button>
                <button class="personality-btn" data-personality="professional">üíº Pro</button>
                <button class="personality-btn" data-personality="creative">üé® Cr√©atif</button>
                <button class="personality-btn" data-personality="funny">üòÑ Dr√¥le</button>
            </div>
        </div>

        <div class="language-selector" id="langSelector">
            <button class="lang-btn active" data-lang="fr">üá´üá∑ Fran√ßais</button>
            <button class="lang-btn" data-lang="en">üá∫üá∏ English</button>
            <button class="lang-btn" data-lang="auto">üîÑ Auto</button>
        </div>

        <div class="main-nav" id="mainNav">
            <button class="main-nav-btn active" data-view="view-chat">üí¨ Chat</button>
            <button class="main-nav-btn" data-view="view-history">üìö Historique</button>
            <button class="main-nav-btn" data-view="view-config">‚öôÔ∏è Configuration</button>
            <button class="main-nav-btn" data-view="view-diagnostics">üìä Diagnostics</button>
        </div>

        <div class="main-content">
            <div class="view active" id="view-chat">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-bubble">
                            Salut ! Je suis ton assistant IA d√©contract√© ! üòä Comment √ßa va aujourd'hui ?
                            <div class="message-actions">
                                <button class="message-btn" title="√âcouter">üîä</button>
                                <button class="message-btn" title="Copier">üìã</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <div class="message ai">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-bubble">
                            Je r√©fl√©chis <div class="typing-dots"><span></span><span></span><span></span></div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <div class="plugins-bar">
                        <button class="plugin-btn" onclick="openPlugin('websearch')">üîç Recherche</button>
                        <button class="plugin-btn" onclick="openPlugin('calculator')">üî¢ Calculette</button>
                        <button class="plugin-btn" onclick="openPlugin('weather')">üå§Ô∏è M√©t√©o</button>
                        <button class="plugin-btn" onclick="openPlugin('jokes')">üòÇ Blagues</button>
                        <button class="plugin-btn" onclick="openPlugin('tips')">üí° Conseils</button>
                    </div>
                    
                    <div class="input-row">
                        <textarea class="input-field" id="messageInput" placeholder="Tape ton message ici..." rows="1"></textarea>
                        <div class="input-controls">
                            <button class="control-btn voice-btn" id="voiceBtn" title="Message vocal">üé§</button>
                            <button class="control-btn send-btn" id="sendBtn" title="Envoyer">üì§</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="view" id="view-config">
                <div class="panel">
                    <!-- Tabs Navigation -->
                    <div class="config-tabs" id="configTabs">
                        <button class="config-tab active" data-tab="general">‚öôÔ∏è G√©n√©ral</button>
                        <button class="config-tab" data-tab="cloud">‚òÅÔ∏è Cloud</button>
                        <button class="config-tab" data-tab="local">üíª Local</button>
                        <button class="config-tab" data-tab="audio">üé§ AV</button>
                        <button class="config-tab" data-tab="hotword">üîä Hotword</button>
                        <button class="config-tab" data-tab="tts">üó£Ô∏è TTS</button>
                        <button class="config-tab" data-tab="advanced">üîß Avanc√©</button>
                    </div>
                    
                    <!-- Tab Content: General -->
                    <div class="config-tab-content active" data-content="general">
                    <div class="panel-section">
                        <h3>‚öôÔ∏è Mode g√©n√©ral</h3>
                        <div class="form-grid">
                            <label>Mode actif
                                <select id="configModeSelect">
                                    <option value="cloud">‚òÅÔ∏è Cloud</option>
                                    <option value="local">üíª Local</option>
                                </select>
                                <small style="font-size: 11px; color: #64748b; margin-top: 4px; display: block;">Choisir le mode √† utiliser (Cloud ou Local)</small>
                            </label>
                            <label>Mod√®le Cloud par d√©faut
                                <select id="configSelectedModel">
                                    <option value="">‚Äì Choisir ‚Äì</option>
                                    <option value="qwen3">Qwen3</option>
                                    <option value="deepseek-r1:7b">DeepSeek R1 7B</option>
                                    <option value="gpt-oss:120b">GPT-OSS 120B</option>
                                    <option value="deepseek-v3.1:671b">DeepSeek V3.1 671B</option>
                                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                                    <option value="llama3.2">Llama 3.2</option>
                                    <option value="mistral-nemo">Mistral Nemo</option>
                                    <option value="custom">Autre (personnalis√©)</option>
                                </select>
                                <input type="text" id="configSelectedModelCustom" class="custom-input hidden" placeholder="Nom du mod√®le personnalis√©">
                                <small style="font-size: 11px; color: #64748b; margin-top: 4px; display: block;">Mod√®le Cloud par d√©faut (utilis√© si aucun mod√®le sp√©cifi√© dans tab Cloud). Ignor√© en mode Local (gemma fix√©).</small>
                            </label>
                        </div>
                        <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button" id="saveModeConfigBtn">üíæ Sauvegarder</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Tab Content: Cloud -->
                    <div class="config-tab-content" data-content="cloud">
                    <div class="panel-section">
                        <h4>‚òÅÔ∏è Cloud (Ollama Cloud API)</h4>
                        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); align-items: start;">
                            <label>
                                <span style="font-weight: 500; margin-bottom: 4px;">Provider</span>
                                <select id="configCloudProvider">
                                    <option value="">‚Äì Choisir ‚Äì</option>
                                    <option value="ollama">Ollama</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="groq">Groq</option>
                                    <option value="perplexity">Perplexity</option>
                                    <option value="custom">Autre (personnalis√©)</option>
                                </select>
                                <input type="text" id="configCloudProviderCustom" class="custom-input hidden" placeholder="Provider personnalis√©">
                            </label>
                            <label>
                                <span style="font-weight: 500; margin-bottom: 4px;">üîë API Key Ollama Cloud</span>
                                <input type="password" id="configCloudApiKey" placeholder="Entrez votre cl√© API Ollama Cloud">
                                <small style="font-size: 11px; color: #64748b; margin-top: 4px; display: block;">Obtenez votre cl√© sur <a href="https://ollama.com/account" target="_blank" style="color: #667eea;">ollama.com/account</a></small>
                            </label>
                            <label>
                                <span style="font-weight: 500; margin-bottom: 4px;">Mod√®le</span>
                                <select id="configCloudModel">
                                    <option value="">‚Äì Choisir ‚Äì</option>
                                    <option value="custom">Autre (personnalis√©)</option>
                                </select>
                                <small style="font-size: 11px; color: #64748b; margin-top: 4px; display: block;">Les mod√®les disponibles seront charg√©s apr√®s le test de connexion</small>
                                <input type="text" id="configCloudModelCustom" class="custom-input hidden" placeholder="Mod√®le cloud personnalis√©">
                            </label>
                        </div>
                        
                        <!-- Zone de r√©sultats des mod√®les disponibles -->
                        <div id="cloudModelsResult" style="display: none; margin-top: 12px; max-height: 200px; overflow-y: auto; overflow-x: hidden; padding: 12px; border-radius: 8px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); scrollbar-width: thin; scrollbar-color: rgba(100, 116, 139, 0.5) transparent;">
                            <style>
                                #cloudModelsResult::-webkit-scrollbar {
                                    width: 6px;
                                }
                                #cloudModelsResult::-webkit-scrollbar-track {
                                    background: transparent;
                                    border-radius: 3px;
                                }
                                #cloudModelsResult::-webkit-scrollbar-thumb {
                                    background: rgba(100, 116, 139, 0.5);
                                    border-radius: 3px;
                                }
                                #cloudModelsResult::-webkit-scrollbar-thumb:hover {
                                    background: rgba(100, 116, 139, 0.7);
                                }
                            </style>
                            <div id="cloudModelsStatus" style="font-weight: 500; margin-bottom: 8px; color: #7c3aed;"></div>
                            <div id="cloudModelsList" style="font-size: 12px; color: #64748b; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace;"></div>
                            <style>
                                .clickable-model {
                                    cursor: pointer;
                                    text-decoration: underline;
                                    color: #667eea;
                                    transition: color 0.2s;
                                }
                                .clickable-model:hover {
                                    color: #4f46e5;
                                }
                                .clickable-model.selected {
                                    font-weight: bold;
                                    color: #10b981;
                                    text-decoration: none;
                                }
                            </style>
                        </div>
                        
                        <!-- Zone de r√©sultats du test de connexion -->
                        <div id="cloudTestResult" style="display: none; margin-top: 12px; max-height: 400px; overflow-y: auto; overflow-x: hidden; padding: 12px; border-radius: 8px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); scrollbar-width: thin; scrollbar-color: rgba(100, 116, 139, 0.5) transparent;">
                            <style>
                                #cloudTestResult::-webkit-scrollbar {
                                    width: 6px;
                                }
                                #cloudTestResult::-webkit-scrollbar-track {
                                    background: transparent;
                                    border-radius: 3px;
                                }
                                #cloudTestResult::-webkit-scrollbar-thumb {
                                    background: rgba(100, 116, 139, 0.5);
                                    border-radius: 3px;
                                }
                                #cloudTestResult::-webkit-scrollbar-thumb:hover {
                                    background: rgba(100, 116, 139, 0.7);
                                }
                            </style>
                            <div id="cloudTestStatus" style="font-weight: 500; margin-bottom: 8px; color: #1e40af;"></div>
                            <div id="cloudTestDetails" style="font-size: 13px; color: #64748b; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;"></div>
                            <div id="cloudTestExpand" style="display: none; margin-top: 8px; font-size: 11px; color: #667eea; cursor: pointer; text-align: center; padding: 4px; border-top: 1px solid rgba(100, 116, 139, 0.2);" onclick="expandCloudTestResult()">
                                ... Voir plus ...
                            </div>
                        </div>
                        
                        <!-- Actions - Group√©es par type -->
                        <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <!-- Actions de test -->
                            <div class="action-section" style="margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üß™ Tests</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <button class="panel-button" id="listCloudModelsBtn" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">üìã Lister les mod√®les</button>
                                    <button class="panel-button" id="testCloudConnectionBtn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">üß™ Tester la connexion</button>
                                </div>
                            </div>
                            
                            <!-- Actions de sauvegarde -->
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button" id="saveCloudConfigBtn">üíæ Sauvegarder</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Tab Content: Local -->
                    <div class="config-tab-content" data-content="local">
                    <div class="panel-section">
                        <h4>üíª Serveur local</h4>
                        <div class="form-grid">
                            <label>URL du serveur Ollama
                                <input type="text" id="configLocalUrl" placeholder="http://127.0.0.1:11434/v1/chat/completions">
                                <small style="font-size: 11px; color: #64748b; margin-top: 4px; display: block;">URL compl√®te avec /v1/chat/completions</small>
                            </label>
                            <label>Mod√®le local
                                <input type="text" id="configLocalModel" value="gemma3-270m.gguf" readonly style="background: rgba(100, 116, 139, 0.1); cursor: not-allowed;">
                                <small style="font-size: 11px; color: #64748b; margin-top: 4px; display: block;">Mod√®le fix√©: gemma3-270m.gguf (disponible dans ChatAI-Files/models/)</small>
                            </label>
                        </div>
                        <!-- ‚≠ê NOUVEAU: Configuration RAG -->
                        <div class="panel-section" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(100, 116, 139, 0.2);">
                            <h4>üîç RAG (Recherche s√©mantique)</h4>
                            <div class="form-grid">
                                <label>Mod√®le d'embedding
                                    <select id="configEmbeddingModel">
                                        <option value="nomic-embed-text">Nomic Embed Text (768 dim)</option>
                                        <option value="mxbai-embed-large">MXBAI Embed Large (1024 dim)</option>
                                    </select>
                                    <small style="font-size: 11px; color: #64748b; margin-top: 4px; display: block;">Mod√®le pour g√©n√©rer des embeddings (RAG). Requis pour recherche s√©mantique dans l'historique.</small>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                                    <input type="checkbox" id="configRAGEnabled" style="width: auto; margin: 0;">
                                    <span>Activer RAG (Recherche s√©mantique dans l'historique)</span>
                                </label>
                                <small style="font-size: 11px; color: #64748b; margin-left: 24px; margin-top: 4px; display: block;">
                                    Le RAG utilise les conversations pr√©c√©dentes pour am√©liorer les r√©ponses. N√©cessite Ollama local avec mod√®le d'embedding.
                                </small>
                            </div>
                        </div>
                        <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button" id="saveLocalConfigBtn">üíæ Sauvegarder</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Tab Content: Audio -->
                    <div class="config-tab-content" data-content="audio">
                    <!-- Web Search & Thinking -->
                    <div class="panel-section">
                        <h4>üîç Web Search & Pens√©e</h4>
                        <div class="form-grid">
                            <label style="grid-column: 1 / -1;">
                                <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Provider (laisser vide pour d√©sactiver)</span>
                                <input type="text" id="configWebSearchProvider" placeholder="ollama">
                            </label>
                            <label style="grid-column: 1 / -1;">
                                <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Thinking trace</span>
                                <select id="configThinkingEnabled">
                                    <option value="">D√©sactiv√©</option>
                                    <option value="auto">Activ√© (auto)</option>
                                </select>
                            </label>
                        </div>
                        <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button" id="saveWebThinkingBtn">üíæ Sauvegarder</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vision -->
                    <div class="panel-section">
                        <h4>üëÅÔ∏è Vision</h4>
                        <div class="form-grid">
                            <label style="grid-column: 1 / -1;">
                                <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Mod√®le vision</span>
                                <select id="configVisionModel">
                                    <option value="">D√©sactiv√©</option>
                                    <option value="llava:13b">LLaVA 13B</option>
                                    <option value="gpt-4o-mini-vision">GPT-4o Mini Vision</option>
                                    <option value="pixtral-12b">Pixtral 12B</option>
                                    <option value="ideogram-v1">Ideogram V1</option>
                                    <option value="custom">Autre (personnalis√©)</option>
                                </select>
                                <input type="text" id="configVisionModelCustom" class="custom-input hidden" placeholder="Mod√®le vision personnalis√©">
                            </label>
                        </div>
                        <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button" id="saveVisionBtn">üíæ Sauvegarder</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Audio -->
                    <div class="panel-section">
                        <h4>üé§ Audio (STT)</h4>
                        <div class="form-grid">
                            <label style="grid-column: 1 / -1;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                    <div>
                                        <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Moteur STT</span>
                                        <select id="configAudioEngine">
                                            <option value="disabled">Disable</option>
                                            <option value="whisper_server" selected>Whisper Server (local HTTP)</option>
                                            <!-- ‚≠ê SIMPLIFI√â : Si "Disable", Google Speech utilise automatiquement Intent standard (comme le clavier Google) via sttStartWhisper() -->
                                        </select>
                                    </div>
                                    <div class="engine-whisper-only">
                                        <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Mod√®le audio</span>
                                        <select id="configAudioModel">
                                            <option value="">D√©sactiv√©</option>
                                            <option value="ggml-small.bin">GGML Small</option>
                                            <option value="ggml-medium.bin">GGML Medium</option>
                                            <option value="ggml-large.bin">GGML Large</option>
                                            <option value="whisper-large-v3">Whisper Large V3</option>
                                            <option value="custom">Autre (personnalis√©)</option>
                                        </select>
                                        <input type="text" id="configAudioModelCustom" class="custom-input hidden" placeholder="Mod√®le audio personnalis√©">
                                    </div>
                                    <div class="engine-whisper-only">
                                        <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Endpoint Whisper Server</span>
                                        <input type="text" id="configAudioEndpoint" placeholder="http://127.0.0.1:11400/inference">
                                    </div>
                                    <div class="engine-whisper-only">
                                        <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Timeout (ms)</span>
                                        <input type="number" id="configAudioTimeout" placeholder="8000">
                                    </div>
                                    <div class="engine-whisper-only">
                                        <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Silence (dB)</span>
                                        <input type="number" step="0.1" id="configAudioSilenceDb" placeholder="-45">
                                    </div>
                                    <div class="engine-whisper-only">
                                        <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Silence (ms)</span>
                                        <input type="number" id="configAudioSilenceMs" placeholder="1200">
                                    </div>
                                    <div>
                                        <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">D√©lai apr√®s hotword (ms)</span>
                                        <input type="number" id="configAudioDelayAfterHotword" placeholder="400" min="0" max="2000">
                                        <small style="font-size: 10px; color: var(--text-secondary); display: block; margin-top: 4px;">D√©lai avant d√©marrage Whisper apr√®s hotword (recommand√©: 400-500ms)</small>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <!-- Actions - Group√©es par type -->
                        <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <!-- Actions de test -->
                            <div class="action-section" style="margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üß™ Tests STT</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px;">
                                    <button class="panel-button secondary engine-whisper-only" onclick="sttPingAction()">üì° Ping Whisper</button>
                                    <button class="panel-button" onclick="sttTestOnceAction()">üé§ Tester STT</button>
                                    <button class="panel-button engine-whisper-only" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="startWhisperServerAction()">üöÄ D√©marrer Whisper</button>
                                </div>
                            </div>
                            
                            <!-- Actions de sauvegarde -->
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button" id="saveAudioBtn">üíæ Sauvegarder</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Tab Content: Hotword -->
                    <div class="config-tab-content" data-content="hotword">
                        <!-- Configuration g√©n√©rale -->
                        <div class="panel-section">
                            <h4>‚öôÔ∏è Configuration g√©n√©rale</h4>
                            <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); align-items: start;">
                                <label style="min-height: auto;">
                                    <input type="checkbox" id="configHotwordEnabled">
                                    <span>Hotword activ√©</span>
                                </label>
                                <label>
                                    <span style="font-weight: 500; margin-bottom: 4px;">Moteur</span>
                                    <select id="configHotwordEngine">
                                        <option value="openwakeword">openWakeWord (recommand√©)</option>
                                        <option value="porcupine">Porcupine (legacy)</option>
                                    </select>
                                </label>
                                <label style="min-height: auto;">
                                    <input type="checkbox" id="configHotwordAutoListen">
                                    <span>Ecoute auto apr√®s hotword (STT ‚Üí IA ‚Üí TTS)</span>
                                </label>
                                <label style="min-height: auto;">
                                    <input type="checkbox" id="configHotwordDebugScores">
                                    <span>Logs score (debug)</span>
                                </label>
                                <label>
                                    <span style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">Debounce (ms)</span>
                                    <input type="number" id="configHotwordDebounce" placeholder="2500" min="1000" max="10000">
                                    <small style="font-size: 10px; color: var(--text-secondary); display: block; margin-top: 4px;">D√©lai minimum entre deux d√©tections (recommand√©: 2000-3000ms)</small>
                                </label>
                                <label class="porcupine-only">
                                    <span style="font-weight: 500; margin-bottom: 4px;">Access Key (Porcupine)</span>
                                    <input type="text" id="configHotwordAccessKey" placeholder="Porcupine access key">
                                </label>
                                <label class="porcupine-only">
                                    <span style="font-weight: 500; margin-bottom: 4px;">Fichier keyword (Porcupine)</span>
                                    <input type="text" id="configHotwordKeyword" placeholder="hotwords/kit-kat_fr_android_v3_0_0.ppn">
                                </label>
                                <label>
                                    <span style="font-weight: 500; margin-bottom: 4px;">Mode de communication par d√©faut</span>
                                    <select id="configHotwordCommMode">
                                        <option value="respond_ai_outside_kitt">R√©ponse IA (hors interface KITT)</option>
                                        <option value="open_kitt_ui">Ouvrir l'interface KITT (legacy)</option>
                                    </select>
                                </label>
                            </div>
                            <!-- Actions - Group√©es par type -->
                            <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                                <!-- Contr√¥les Hotword -->
                                <div class="action-section" style="margin-bottom: 16px;">
                                    <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">‚ö° Contr√¥les</div>
                                    <div class="button-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                        <button class="panel-button" id="hotwordStartBtn">‚ñ∂Ô∏è D√©marrer</button>
                                        <button class="panel-button secondary" id="hotwordStopBtn">‚èπÔ∏è Arr√™ter</button>
                                        <button class="panel-button" id="hotwordRestartBtn">üîÑ Red√©marrer</button>
                                    </div>
                                </div>
                                
                                <!-- Actions de sauvegarde -->
                                <div class="action-section">
                                    <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                    <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                        <button class="panel-button" id="saveHotwordBtn">üíæ Sauvegarder la configuration</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Liste des mod√®les et ajout -->
                        <div class="panel-section">
                            <h4>üìã Mod√®les Hotword</h4>
                            <div class="hotword-models-grid" id="hotwordModelsGrid">
                                <div class="hotword-model-card-empty">
                                    Aucun mod√®le configur√©. Utilisez "Importer depuis assets" ou "Ajouter un mod√®le" ci-dessous.
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                                <h5 class="add-model-toggle" style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; gap: 8px; user-select: none;">
                                    <span class="toggle-icon" style="transition: transform 0.3s ease; display: inline-block;">‚ñº</span>
                                    <span>‚ûï Ajouter un mod√®le</span>
                                </h5>
                                <div class="add-model-content" style="display: none;">
                                    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                                        <label>
                                            <span style="font-weight: 500; margin-bottom: 4px;">Nom du mod√®le</span>
                                            <input type="text" id="hotwordNewName" placeholder="hey_kitt">
                                        </label>
                                        <label>
                                            <span style="font-weight: 500; margin-bottom: 4px;">Chemin asset</span>
                                            <input type="text" id="hotwordNewAsset" placeholder="hotwords/.../file.tflite">
                                        </label>
                                        <label>
                                            <span style="font-weight: 500; margin-bottom: 4px;">Seuil de d√©tection</span>
                                            <input type="number" step="0.01" id="hotwordNewThreshold" placeholder="0.55" min="0" max="1">
                                        </label>
                                    </div>
                                    <div class="action-section" style="margin-top: 16px;">
                                        <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üì¶ Gestion des mod√®les</div>
                                        <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                            <button class="panel-button secondary" id="importHotwordAssetsBtn">üì• Importer depuis assets</button>
                                            <button class="panel-button secondary" id="addHotwordModelBtn">‚ûï Ajouter le mod√®le</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Content: TTS -->
                    <div class="config-tab-content" data-content="tts">
                    <div class="panel-section">
                        <h4>üéôÔ∏è TTS</h4>
                        <div class="form-grid">
                            <label>Mode
                                <input type="text" id="configTtsMode" placeholder="local">
                            </label>
                            <label>Voix
                                <select id="configTtsVoice">
                                    <option value="">‚Äì Choisir ‚Äì</option>
                                    <option value="kitt">KITT</option>
                                    <option value="glados">GLaDOS</option>
                                    <option value="karr">KARR</option>
                                    <option value="sarah">Sarah</option>
                                    <option value="jarvis">Jarvis</option>
                                    <option value="custom">Autre (personnalis√©)</option>
                                </select>
                                <input type="text" id="configTtsVoiceCustom" class="custom-input hidden" placeholder="Voix personnalis√©e">
                            </label>
                        </div>
                        <div class="form-checkbox" style="margin-top: 10px; margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="configTtsAutoPlay" style="width: auto; margin: 0;">
                                <span>Lecture automatique des r√©ponses (TTS)</span>
                            </label>
                            <span style="font-size: 12px; color: var(--text-secondary); margin-left: 24px; display: block; margin-top: 4px;">
                                Les r√©ponses de l'IA seront automatiquement lues √† voix haute (voix KITT)
                            </span>
                        </div>
                        <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button" id="saveTtsBtn">üíæ Sauvegarder</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    
                    <!-- Tab Content: Advanced -->
                    <div class="config-tab-content" data-content="advanced">
                    <div class="panel-section">
                        <h4>üîß Prompts & Contraintes</h4>
                        <div class="form-grid">
                            <label>Prompt KITT
                                <textarea id="configPromptKitt" rows="2"></textarea>
                            </label>
                            <label>Prompt GLaDOS
                                <textarea id="configPromptGlados" rows="2"></textarea>
                            </label>
                            <label>Prompt KARR
                                <textarea id="configPromptKarr" rows="2"></textarea>
                            </label>
                            <label>Max context tokens
                                <input type="number" id="configMaxContext" placeholder="8192">
                            </label>
                            <label>Max r√©ponse tokens
                                <input type="number" id="configMaxResponse" placeholder="2048">
                            </label>
                        </div>
                        <div class="config-actions-group" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üíæ Sauvegarde</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <button class="panel-button" id="savePromptsBtn">üíæ Sauvegarder prompts</button>
                                    <button class="panel-button" id="saveConstraintsBtn">üíæ Sauvegarder contraintes</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="panel-section">
                        <h4>JSON brut</h4>
                        <p class="panel-placeholder">Aper√ßu du fichier <code>ai_config.json</code>. Utilisez l‚Äô√©diteur pour des modifications avanc√©es.</p>
                        <pre class="panel-json" id="aiConfigPreview">Chargement...</pre>
                        <div class="config-actions-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">‚ö° Actions</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <button class="panel-button" id="aiConfigReloadBtn">üîÑ Recharger</button>
                                    <button class="panel-button secondary" id="aiConfigEditBtn">‚úèÔ∏è Modifier JSON</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <div class="view" id="view-diagnostics">
                <div class="panel">
                    <div class="panel-section">
                        <h3>üìä Diagnostics</h3>
                        <div class="config-actions-group" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">‚ö° Actions</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <button class="panel-button" id="diagnosticsRefreshBtn">üîÑ Rafra√Æchir</button>
                                    <button class="panel-button secondary" id="diagnosticsGenerateHtmlBtn">üìÑ G√©n√©rer HTML</button>
                                </div>
                            </div>
                            <div class="action-section" style="margin-top: 16px;">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üåê Acc√®s r√©seau</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button secondary" id="diagnosticsOpenHtmlBtn" disabled>üîó Ouvrir diagnostics.html</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Services -->
                    <div class="panel-section">
                        <h4>üîå Services</h4>
                        <div class="status-grid" id="servicesStatusGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <div style="font-size: 48px; margin-bottom: 12px;">üîÑ</div>
                                <div>Chargement des statuts...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Syst√®me -->
                    <div class="panel-section">
                        <h4>üíª Syst√®me</h4>
                        <div class="status-grid" id="systemInfoGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <div style="font-size: 48px; margin-bottom: 12px;">üîÑ</div>
                                <div>Chargement des informations...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Logs Fichier -->
                    <div class="panel-section">
                        <h4>üìÑ Logs Fichier</h4>
                        <div id="logFileContainer" style="margin-top: 16px; max-height: 400px; overflow-y: auto; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px; padding: 16px;">
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <div style="font-size: 48px; margin-bottom: 12px;">üìÑ</div>
                                <div>Chargement des logs fichier...</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Logs M√©moire -->
                    <div class="panel-section">
                        <h4>üß† Logs M√©moire</h4>
                        <div id="diagnosticLogsContainer" style="margin-top: 16px; max-height: 400px; overflow-y: auto; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 8px; padding: 16px;">
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <div style="font-size: 48px; margin-bottom: 12px;">üß†</div>
                                <div>Chargement des logs m√©moire...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚≠ê NOUVEAU: Vue Historique -->
            <div class="view" id="view-history">
                <div class="panel">
                    <div class="panel-section">
                        <h3>üìö Historique des conversations</h3>
                        
                        <!-- Statistiques -->
                        <div class="history-stats-group" style="margin-bottom: 24px; padding: 16px; background: rgba(15, 23, 42, 0.3); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
                            <div style="font-size: 13px; color: #94a3b8; margin-bottom: 12px; font-weight: 500;">üìä Statistiques</div>
                            <div class="panel-stats" id="historyStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div class="stat-card" style="background: rgba(59, 130, 246, 0.1); padding: 16px; border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.3); text-align: center;">
                                    <div class="stat-label" style="font-size: 11px; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Total</div>
                                    <div class="stat-value" id="statTotal" style="font-size: 24px; font-weight: 700; color: #3b82f6; line-height: 1.2;">-</div>
                                </div>
                                <div class="stat-card" style="background: rgba(139, 92, 246, 0.1); padding: 16px; border-radius: 10px; border: 1px solid rgba(139, 92, 246, 0.3); text-align: center;">
                                    <div class="stat-label" style="font-size: 11px; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Temps moyen</div>
                                    <div class="stat-value" id="statAvgTime" style="font-size: 24px; font-weight: 700; color: #8b5cf6; line-height: 1.2;">-</div>
                                </div>
                                <div class="stat-card" style="background: rgba(236, 72, 153, 0.1); padding: 16px; border-radius: 10px; border: 1px solid rgba(236, 72, 153, 0.3); text-align: center;">
                                    <div class="stat-label" style="font-size: 11px; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">API principale</div>
                                    <div class="stat-value" id="statMainAPI" style="font-size: 18px; font-weight: 700; color: #ec4899; line-height: 1.2; word-break: break-word;">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recherche et filtres -->
                        <div class="history-search-group" style="margin-bottom: 20px; padding: 16px; background: rgba(15, 23, 42, 0.3); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.2);">
                            <label style="display: block; margin-bottom: 12px;">
                                <span style="font-size: 13px; color: #94a3b8; margin-bottom: 6px; display: block;">üîç Recherche</span>
                                <input type="text" id="historySearchInput" placeholder="Rechercher dans l'historique..." style="width: 100%; padding: 12px; border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; background: rgba(15, 23, 42, 0.5); color: #e2e8f0; font-size: 14px;">
                            </label>
                            <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <button class="panel-button" id="historySearchBtn" style="padding: 10px 16px;">üîç Rechercher</button>
                                <button class="panel-button secondary" id="historyClearBtn" style="padding: 10px 16px;">üóëÔ∏è Effacer</button>
                            </div>
                        </div>
                        
                        <!-- Actions - Group√©es par type -->
                        <div class="history-actions-group" style="margin-bottom: 20px;">
                            <!-- Actions g√©n√©rales -->
                            <div class="action-section" style="margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">‚ö° Actions</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                                    <button class="panel-button" id="historyRefreshBtn">üîÑ Rafra√Æchir</button>
                                </div>
                            </div>
                            
                            <!-- Export -->
                            <div class="action-section" style="margin-bottom: 16px;">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">üì§ Export</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                    <button class="panel-button secondary" id="historyExportJSONBtn">üíæ JSON</button>
                                    <button class="panel-button secondary" id="historyExportHTMLBtn">üìÑ HTML</button>
                                </div>
                            </div>
                            
                            <!-- Actions dangereuses -->
                            <div class="action-section">
                                <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">‚ö†Ô∏è Danger</div>
                                <div class="button-grid" style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                    <button class="panel-button danger" id="historyDeleteAllBtn" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);">üóëÔ∏è Effacer tout l'historique</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liste des conversations -->
                    <div class="panel-section">
                        <div id="historyListContainer" style="max-height: 500px; overflow-y: auto; overflow-x: hidden;">
                            <div id="historyList" style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="text-align: center; padding: 40px; color: #64748b;">
                                    <div style="font-size: 48px; margin-bottom: 12px;">üìö</div>
                                    <div>Chargement de l'historique...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="plugin-modal" id="pluginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Plugin</h3>
                <button class="close-btn" onclick="closePlugin()">√ó</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <div class="plugin-modal" id="infoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üöÄ Informations Syst√®me</h3>
                <button class="close-btn" onclick="closeInfo()">√ó</button>
            </div>
            <div id="infoContent">
                <div style="padding: 20px; text-align: center;">
                    <h4>üì± Application ChatAI-Android</h4>
                    <p style="margin: 10px 0;">Version compl√®te avec toutes les fonctionnalit√©s principales.</p>
                    
                    <div style="margin: 20px 0; text-align: left;">
                        <h5 style="margin-bottom: 10px; color: #667eea;">üåê Serveurs Locaux :</h5>
                        <p style="margin: 5px 0;"><strong>HTTP Server :</strong> <span id="httpStatus">V√©rification...</span></p>
                        <p style="margin: 5px 0;"><strong>WebSocket Server :</strong> <span id="wsStatus">V√©rification...</span></p>
                        <p style="margin: 5px 0;"><strong>Service IA :</strong> <span id="aiStatus">V√©rification...</span></p>
                    </div>
                    
                    <div style="margin: 20px 0; text-align: left;">
                        <h5 style="margin-bottom: 10px; color: #667eea;">üîå Plugins Disponibles :</h5>
                        <p style="margin: 5px 0;">üîç Recherche Web | üî¢ Calculette | üå§Ô∏è M√©t√©o</p>
                        <p style="margin: 5px 0;">üòÇ Blagues | üí° Conseils</p>
                    </div>
                    
                    <div style="margin: 20px 0; text-align: left;">
                        <h5 style="margin-bottom: 10px; color: #667eea;">üîí S√©curit√© :</h5>
                        <p style="margin: 5px 0;">‚úÖ Validation XSS</p>
                        <p style="margin: 5px 0;">‚úÖ Cache s√©curis√©</p>
                        <p style="margin: 5px 0;">‚úÖ Gestion des permissions Android</p>
                    </div>
                    
                    <button onclick="testServers()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; border: none; border-radius: 8px; margin-top: 15px; font-weight: 600; cursor: pointer;">üß™ Tester les Serveurs</button>
                </div>
            </div>
        </div>
    </div>

    <div class="plugin-modal" id="jsonModal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3>√âditeur ai_config.json</h3>
                <button class="close-btn" id="closeJsonModal">√ó</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 10px; font-size: 12px; color: #94a3b8;">Chemin: /storage/emulated/0/ChatAI-Files/config/ai_config.json</p>
                <textarea id="aiConfigEditor" style="width: 100%; height: 260px; background: #0f172a; color: #e2e8f0; border: 1px solid rgba(148, 163, 184, 0.3); border-radius: 8px; padding: 12px; font-family: 'Fira Code', 'Courier New', monospace; font-size: 12px; resize: vertical;"></textarea>
                <div class="config-actions-group" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                    <div class="action-section">
                        <div style="font-size: 13px; color: #94a3b8; margin-bottom: 8px; font-weight: 500;">‚ö° Actions</div>
                        <div class="button-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <button class="panel-button" id="aiConfigSaveBtn">üíæ Sauvegarder</button>
                            <button class="panel-button secondary" id="aiConfigEditorReloadBtn">üîÑ Recharger</button>
                        </div>
                    </div>
                </div>
                <div id="aiConfigFeedback" style="margin-top: 8px; font-size: 12px; color: #94a3b8;"></div>
            </div>
        </div>
    </div>

    <!-- Modules modulaires (refactorisation) - ACTIV√âS -->
    <script src="chat-utils.js"></script>
    <script src="chat-ui.js"></script>
    <script src="chat-config.js"></script>
    <script src="chat-messaging.js"></script>
    <script src="chat-speech.js"></script>
    <script src="chat-bridge.js"></script>
    <script src="chat-hotword.js"></script>
    <script src="chat-history.js"></script>
    <script src="chat-diagnostics.js"></script>
    <script src="chat-core.js"></script>
    <!-- <script src="chat.js"></script> --> <!-- D√âSACTIV√â - Remplac√© par modules modulaires -->
    <script>
        // Fonctions utilitaires globales pour les plugins
        
        function speakText(button) {
            if ('speechSynthesis' in window && window.secureChatApp) {
                const messageText = button.closest('.message-bubble').textContent.replace(/[üîäüìã]/g, '').trim();
                window.secureChatApp.speakText(messageText);
            }
        }

        function openPlugin(pluginType) {
            const modal = document.getElementById('pluginModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            const plugins = {
                websearch: {
                    title: 'üîç Recherche Web',
                    content: `<div style="text-align: center;">
                        <input type="text" id="searchQuery" placeholder="Bitcoin, m√©t√©o, actualit√©s..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
                        <button onclick="performWebSearch()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üîç Rechercher sur le web</button>
                        <div id="searchResults" style="background: #f8f9fa; padding: 15px; border-radius: 8px; display: none; margin-top: 10px; max-height: 300px; overflow-y: auto; text-align: left; font-size: 13px; line-height: 1.6;"></div>
                    </div>`
                },
                calculator: {
                    title: 'üî¢ Calculette',
                    content: `<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <input type="text" id="calcDisplay" readonly style="grid-column: span 4; padding: 15px; font-size: 18px; text-align: right; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;">
                        <button onclick="clearCalc()" style="grid-column: span 2; padding: 15px; background: #ff4757; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">C</button>
                        <button onclick="deleteLast()" style="grid-column: span 2; padding: 15px; background: #ffa502; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">‚å´</button>
                        <button onclick="addToCalc('7')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">7</button>
                        <button onclick="addToCalc('8')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">8</button>
                        <button onclick="addToCalc('9')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">9</button>
                        <button onclick="addToCalc('/')" style="padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">/</button>
                        <button onclick="addToCalc('4')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">4</button>
                        <button onclick="addToCalc('5')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">5</button>
                        <button onclick="addToCalc('6')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">6</button>
                        <button onclick="addToCalc('*')" style="padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">*</button>
                        <button onclick="addToCalc('1')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">1</button>
                        <button onclick="addToCalc('2')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">2</button>
                        <button onclick="addToCalc('3')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">3</button>
                        <button onclick="addToCalc('-')" style="padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">-</button>
                        <button onclick="addToCalc('0')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">0</button>
                        <button onclick="addToCalc('.')" style="padding: 15px; background: #f1f2f6; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">.</button>
                        <button onclick="calculate()" style="padding: 15px; background: #4ECDC4; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;">=</button>
                        <button onclick="addToCalc('+')" style="padding: 15px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">+</button>
                    </div>`
                },
                weather: {
                    title: 'üå§Ô∏è M√©t√©o',
                    content: `<div style="text-align: center;">
                        <input type="text" id="cityInput" placeholder="Entrez une ville..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; font-size: 14px;">
                        <button onclick="getWeather()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #4ECDC4, #44A08D); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Obtenir la m√©t√©o</button>
                        <div id="weatherResult" style="background: #f8f9fa; padding: 15px; border-radius: 8px; display: none; margin-top: 10px;"></div>
                    </div>`
                },
                jokes: {
                    title: 'üòÇ G√©n√©rateur de Blagues',
                    content: `<div style="text-align: center;">
                        <button onclick="getRandomJoke()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff6b6b, #ee5a6f); color: white; border: none; border-radius: 8px; margin-bottom: 15px; font-weight: bold; cursor: pointer;">üé≤ Blague al√©atoire</button>
                        <div id="jokeResult" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 80px; display: flex; align-items: center; justify-content: center; font-style: italic; color: #666; line-height: 1.6;">Cliquez pour une blague ! üòÑ</div>
                    </div>`
                },
                tips: {
                    title: 'üí° Conseils du Jour',
                    content: `<div style="text-align: center;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                            <button onclick="getTip('productivity')" style="padding: 12px; background: #4ECDC4; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üìà Productivit√©</button>
                            <button onclick="getTip('health')" style="padding: 12px; background: #ff6b6b; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üèÉ‚Äç‚ôÇÔ∏è Sant√©</button>
                            <button onclick="getTip('tech')" style="padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üíª Tech</button>
                            <button onclick="getTip('lifestyle')" style="padding: 12px; background: #ffa502; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">üåü Lifestyle</button>
                        </div>
                        <div id="tipResult" style="background: #f8f9fa; padding: 20px; border-radius: 8px; min-height: 100px; display: flex; align-items: center; justify-content: center; font-style: italic; color: #666; line-height: 1.6;">Choisissez une cat√©gorie ! üí°</div>
                    </div>`
                }
            };
            
            const plugin = plugins[pluginType];
            if (plugin) {
                title.textContent = plugin.title;
                content.innerHTML = plugin.content;
                modal.style.display = 'block';
            }
        }

        function closePlugin() {
            document.getElementById('pluginModal').style.display = 'none';
        }

        // Fonctions de la calculatrice
        function addToCalc(value) { 
            const display = document.getElementById('calcDisplay');
            if (display) display.value += value; 
        }

        function clearCalc() { 
            const display = document.getElementById('calcDisplay');
            if (display) display.value = ''; 
        }

        function deleteLast() { 
            const display = document.getElementById('calcDisplay');
            if (display) display.value = display.value.slice(0, -1); 
        }

        function calculate() {
            const display = document.getElementById('calcDisplay');
            if (!display) return;
            
            try {
                const expression = display.value;
                if (!/^[0-9+\-*/.() ]+$/.test(expression)) {
                    display.value = 'Erreur';
                    return;
                }
                
                const result = Function('"use strict"; return (' + expression + ')')();
                display.value = result;
            } catch (error) {
                display.value = 'Erreur';
            }
        }

        // Fonction de recherche web
        function performWebSearch() {
            const searchQuery = document.getElementById('searchQuery');
            const searchResults = document.getElementById('searchResults');
            if (!searchQuery || !searchResults) return;
            
            const query = searchQuery.value.trim();
            if (!query) return;
            
            const safeQuery = query.replace(/[<>]/g, '');
            
            searchResults.innerHTML = '<div style="text-align: center; padding: 20px;">üîÑ Recherche en cours...</div>';
            searchResults.style.display = 'block';
            
            fetch(`/api/search?q=${encodeURIComponent(safeQuery)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        searchResults.innerHTML = `
                            <h4 style="margin-bottom: 10px;">üîç R√©sultats pour "${data.query}":</h4>
                            <div style="white-space: pre-wrap;">${data.results}</div>
                        `;
                    } else {
                        searchResults.innerHTML = `<p style="color: #999;">Aucun r√©sultat trouv√© pour "${data.query}"</p>`;
                    }
                })
                .catch(error => {
                    console.error('Erreur recherche web:', error);
                    searchResults.innerHTML = `<p style="color: #ff4757;">‚ùå Erreur: ${error.message}</p>`;
                });
        }

        // Fonction m√©t√©o
        function getWeather() {
            const cityInput = document.getElementById('cityInput');
            const weatherResult = document.getElementById('weatherResult');
            if (!cityInput || !weatherResult) return;
            
            const city = cityInput.value.trim();
            if (!city) return;
            
            const safeCity = city.replace(/[<>]/g, '');
            
            if (window.secureChatApp?.androidInterface?.getHttpServerUrl) {
                const serverUrl = window.secureChatApp.androidInterface.getHttpServerUrl();
                fetch(`${serverUrl}/api/weather/${encodeURIComponent(safeCity)}`)
                    .then(response => response.json())
                    .then(data => {
                        weatherResult.innerHTML = `
                            <h3 style="margin-bottom: 10px;">üìç ${data.city}</h3>
                            <div style="font-size: 32px; margin: 10px 0;">üå°Ô∏è ${data.temperature}¬∞C</div>
                            <div style="font-size: 18px; margin: 5px 0;">${data.condition}</div>
                            <div style="font-size: 13px; color: #666; margin-top: 10px;">Humidit√©: ${data.humidity}% | Vent: ${data.wind}</div>
                        `;
                        weatherResult.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Erreur API m√©t√©o:', error);
                        getWeatherFallback(safeCity, weatherResult);
                    });
            } else {
                getWeatherFallback(safeCity, weatherResult);
            }
        }

        function getWeatherFallback(city, resultElement) {
            const temp = Math.floor(Math.random() * 25) + 5;
            const conditions = ['Ensoleill√© ‚òÄÔ∏è', 'Nuageux ‚òÅÔ∏è', 'Pluvieux üåßÔ∏è'];
            const condition = conditions[Math.floor(Math.random() * conditions.length)];
            
            resultElement.innerHTML = `
                <h3 style="margin-bottom: 10px;">üìç ${city}</h3>
                <div style="font-size: 32px; margin: 10px 0;">üå°Ô∏è ${temp}¬∞C</div>
                <div style="font-size: 18px;">${condition}</div>
            `;
            resultElement.style.display = 'block';
        }

        // Fonction blagues
        function getRandomJoke() {
            const jokeResult = document.getElementById('jokeResult');
            if (!jokeResult) return;
            
            if (window.secureChatApp?.androidInterface?.getHttpServerUrl) {
                const serverUrl = window.secureChatApp.androidInterface.getHttpServerUrl();
                fetch(`${serverUrl}/api/jokes/random`)
                    .then(response => response.json())
                    .then(data => {
                        jokeResult.innerHTML = data.joke;
                    })
                    .catch(error => {
                        console.error('Erreur API blagues:', error);
                        getRandomJokeFallback(jokeResult);
                    });
            } else {
                getRandomJokeFallback(jokeResult);
            }
        }

        function getRandomJokeFallback(resultElement) {
            const jokes = [
                "Pourquoi les plongeurs plongent-ils toujours en arri√®re ? Parce que sinon, ils tombent dans le bateau ! üòÇ",
                "Comment appelle-t-on un chat tomb√© dans un pot de peinture ? Un chat-mallow ! üé®",
                "Que dit un escargot quand il croise une limace ? 'Regarde le nudiste !' üêå",
                "Qu'est-ce qu'un crocodile qui surveille une √©cole ? Un Lacoste Gardien ! üêä",
                "Pourquoi les poissons n'aiment pas jouer au tennis ? Parce qu'ils ont peur du filet ! üêü"
            ];
            resultElement.innerHTML = jokes[Math.floor(Math.random() * jokes.length)];
        }

        // Fonction conseils
        function getTip(category) {
            const tipResult = document.getElementById('tipResult');
            if (!tipResult) return;
            
            if (window.secureChatApp?.androidInterface?.getHttpServerUrl) {
                const serverUrl = window.secureChatApp.androidInterface.getHttpServerUrl();
                fetch(`${serverUrl}/api/tips/${encodeURIComponent(category)}`)
                    .then(response => response.json())
                    .then(data => {
                        tipResult.innerHTML = data.tip;
                    })
                    .catch(error => {
                        console.error('Erreur API conseils:', error);
                        getTipFallback(category, tipResult);
                    });
            } else {
                getTipFallback(category, tipResult);
            }
        }

        function getTipFallback(category, resultElement) {
            const tips = {
                productivity: "üèÜ Technique Pomodoro : Travaillez 25 minutes, puis faites une pause de 5 minutes. R√©p√©tez 4 fois, puis prenez une pause de 15-30 minutes.",
                health: "üíß Buvez un grand verre d'eau d√®s le r√©veil pour r√©hydrater votre corps apr√®s la nuit. Votre cerveau vous remerciera !",
                tech: "üîê Utilisez un gestionnaire de mots de passe pour cr√©er et stocker des mots de passe uniques et forts pour chaque compte.",
                lifestyle: "üìö Lisez 10 pages par jour. En un an, vous aurez lu environ 3650 pages, soit environ 12 livres !"
            };
            resultElement.innerHTML = tips[category] || "Conseil non disponible";
        }

        // Fonctions de navigation
        function showInfo() {
            const modal = document.getElementById('infoModal');
            modal.style.display = 'block';
            checkServerStatus();
        }

        function closeInfo() {
            document.getElementById('infoModal').style.display = 'none';
        }

        function checkServerStatus() {
            const httpStatus = document.getElementById('httpStatus');
            const wsStatus = document.getElementById('wsStatus');
            const aiStatus = document.getElementById('aiStatus');
            
            if (window.secureChatApp?.androidInterface) {
                try {
                    const httpUrl = window.secureChatApp.androidInterface.getHttpServerUrl?.();
                    if (httpUrl) {
                        httpStatus.innerHTML = '‚úÖ Actif (' + httpUrl + ')';
                        httpStatus.style.color = 'green';
                    } else {
                        httpStatus.innerHTML = '‚ùå Inactif';
                        httpStatus.style.color = 'red';
                    }
                } catch (e) {
                    httpStatus.innerHTML = '‚ùå Erreur';
                    httpStatus.style.color = 'red';
                }
                
                try {
                    const wsCount = window.secureChatApp.androidInterface.getWebSocketClientsCount?.() || 'N/A';
                    wsStatus.innerHTML = '‚úÖ Actif (' + wsCount + ' clients)';
                    wsStatus.style.color = 'green';
                } catch (e) {
                    wsStatus.innerHTML = '‚ùå Erreur';
                    wsStatus.style.color = 'red';
                }
                
                try {
                    const aiStats = window.secureChatApp.androidInterface.getAIServiceStats?.();
                    if (aiStats && aiStats.includes('healthy')) {
                        aiStatus.innerHTML = '‚úÖ Actif';
                        aiStatus.style.color = 'green';
                    } else {
                        aiStatus.innerHTML = '‚ùå Inactif';
                        aiStatus.style.color = 'red';
                    }
                } catch (e) {
                    aiStatus.innerHTML = '‚ùå Erreur';
                    aiStatus.style.color = 'red';
                }
            } else {
                httpStatus.innerHTML = '‚ùå Interface non disponible';
                wsStatus.innerHTML = '‚ùå Interface non disponible';
                aiStatus.innerHTML = '‚ùå Interface non disponible';
            }
        }

        function testServers() {
            const button = event.target;
            button.innerHTML = 'üîÑ Test en cours...';
            button.disabled = true;
            
            setTimeout(() => {
                if (window.secureChatApp?.androidInterface) {
                    const httpUrl = window.secureChatApp.androidInterface.getHttpServerUrl?.();
                    if (httpUrl) {
                        fetch(httpUrl + '/api/status')
                            .then(response => response.json())
                            .then(data => {
                                alert('‚úÖ Serveur HTTP : ' + data.server + ' (Version ' + data.version + ')');
                            })
                            .catch(error => {
                                alert('‚ùå Erreur serveur HTTP : ' + error.message);
                            });
                    } else {
                        alert('‚ùå Serveur HTTP non disponible');
                    }
                } else {
                    alert('‚ùå Interface Android non disponible');
                }
                
                button.innerHTML = 'üß™ Tester les Serveurs';
                button.disabled = false;
            }, 1000);
        }

        function openSettings() {
            if (window.secureChatApp?.androidInterface?.openSettingsActivity) {
                window.secureChatApp.androidInterface.openSettingsActivity();
            } else {
                alert('‚öôÔ∏è Param√®tres\nüöß Fonctionnalit√© en d√©veloppement');
            }
        }

        function openDatabase() {
            if (window.secureChatApp?.androidInterface?.openDatabaseActivity) {
                window.secureChatApp.androidInterface.openDatabaseActivity();
            } else {
                alert('üíæ Base de donn√©es\nüöß Fonctionnalit√© en d√©veloppement');
            }
        }

        function openServers() {
            if (window.secureChatApp?.androidInterface?.openServerActivity) {
                window.secureChatApp.androidInterface.openServerActivity();
            } else {
                alert('üåê Serveurs\nüöß Fonctionnalit√© en d√©veloppement');
            }
        }

        // STT helpers
        function sttPingAction() {
            try {
                const ok = window.secureChatApp?.androidInterface?.sttPing?.();
                alert(ok ? '‚úÖ Whisper Server disponible' : '‚ùå Whisper Server indisponible');
            } catch (e) {
                alert('‚ùå Erreur ping STT: ' + e.message);
            }
        }
        
        function startWhisperServerAction() {
            try {
                window.secureChatApp?.androidInterface?.startWhisperServer?.();
            } catch (e) {
                alert('‚ùå Erreur d√©marrage Whisper Server: ' + e.message);
            }
        }
        function sttTestOnceAction() {
            try {
                window.secureChatApp?.androidInterface?.sttTestOnce?.();
            } catch (e) {
                alert('‚ùå Erreur test STT: ' + e.message);
            }
        }

        // Ajouter les √©v√©nements pour les boutons de navigation
        document.addEventListener('DOMContentLoaded', () => {
            const infoBtn = document.getElementById('infoBtn');
            if (infoBtn) {
                infoBtn.addEventListener('click', showInfo);
            }
            
            const settingsBtn = document.getElementById('settingsBtn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', openSettings);
            }
            
            const databaseBtn = document.getElementById('databaseBtn');
            if (databaseBtn) {
                databaseBtn.addEventListener('click', openDatabase);
            }
            
            const serverBtn = document.getElementById('serverBtn');
            if (serverBtn) {
                serverBtn.addEventListener('click', openServers);
            }
            
          // Lister les mod√®les Ollama Cloud
          const listModelsBtn = document.getElementById('listCloudModelsBtn');
          if (listModelsBtn) {
              listModelsBtn.addEventListener('click', listCloudModels);
          }
          
          // Test de connexion Ollama Cloud
          const testCloudBtn = document.getElementById('testCloudConnectionBtn');
          if (testCloudBtn) {
              testCloudBtn.addEventListener('click', testOllamaCloudConnection);
          }
          
          // G√©rer l'affichage/masquage de l'input personnalis√© pour le mod√®le Cloud
          const cloudModelSelect = document.getElementById('configCloudModel');
          const cloudModelCustomInput = document.getElementById('configCloudModelCustom');
          if (cloudModelSelect && cloudModelCustomInput) {
              cloudModelSelect.addEventListener('change', function() {
                  if (this.value === 'custom') {
                      cloudModelCustomInput.classList.remove('hidden');
                      cloudModelCustomInput.focus();
                  } else {
                      cloudModelCustomInput.classList.add('hidden');
                      cloudModelCustomInput.value = '';
                  }
                  
                  // Mettre √† jour le style dans la liste (si elle existe)
                  const modelsListDiv = document.getElementById('cloudModelsList');
                  if (modelsListDiv && this.value && this.value !== 'custom') {
                      const allSpans = modelsListDiv.querySelectorAll('.clickable-model');
                      allSpans.forEach(span => {
                          const spanModel = span.getAttribute('data-model');
                          const unescapedSpanModel = spanModel ? spanModel.replace(/\\'/g, "'").replace(/&quot;/g, '"') : '';
                          if (unescapedSpanModel === this.value) {
                              span.classList.add('selected');
                          } else {
                              span.classList.remove('selected');
                          }
                      });
                  }
              });
              
              // Charger les mod√®les sauvegard√©s au d√©marrage
              const savedModels = loadCloudModelsFromStorage();
              if (savedModels && savedModels.length > 0) {
                  populateCloudModelDropdown(savedModels);
              }
          }
      });

        // Fonction pour lister les mod√®les disponibles (sans test de connexion)
        async function listCloudModels() {
            const apiKeyField = document.getElementById('configCloudApiKey');
            let apiKey = apiKeyField.value.trim();
            
            // Si la cl√© contient des ast√©risques (masqu√©e), r√©cup√©rer la vraie cl√© depuis data-original-key
            if (apiKey && apiKey.includes('*')) {
                const originalKey = apiKeyField.getAttribute('data-original-key') || '';
                if (originalKey) {
                    apiKey = originalKey;
                }
            }
            
            const modelsResultDiv = document.getElementById('cloudModelsResult');
            const modelsStatusDiv = document.getElementById('cloudModelsStatus');
            const modelsListDiv = document.getElementById('cloudModelsList');
            const listBtn = document.getElementById('listCloudModelsBtn');
            
            if (!apiKey) {
                modelsResultDiv.style.display = 'block';
                modelsResultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                modelsResultDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                modelsStatusDiv.innerHTML = '‚ùå Cl√© API manquante';
                modelsStatusDiv.style.color = '#dc2626';
                modelsListDiv.textContent = 'Veuillez entrer votre cl√© API Ollama Cloud';
                return;
            }
            
            // Nettoyer la cl√© API (supprimer espaces, caract√®res de contr√¥le)
            const cleanApiKey = apiKey.replace(/\s+/g, '').replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g, '');
            
            if (!cleanApiKey) {
                modelsResultDiv.style.display = 'block';
                modelsResultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                modelsResultDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                modelsStatusDiv.innerHTML = '‚ùå Cl√© API invalide';
                modelsStatusDiv.style.color = '#dc2626';
                modelsListDiv.textContent = 'La cl√© API ne peut pas √™tre vide apr√®s nettoyage';
                return;
            }
            
            // Afficher "R√©cup√©ration en cours..."
            modelsResultDiv.style.display = 'block';
            modelsResultDiv.style.background = 'rgba(139, 92, 246, 0.1)';
            modelsResultDiv.style.borderColor = 'rgba(139, 92, 246, 0.3)';
            modelsStatusDiv.innerHTML = '‚è≥ R√©cup√©ration des mod√®les disponibles...';
            modelsStatusDiv.style.color = '#7c3aed';
            modelsListDiv.textContent = '';
            listBtn.disabled = true;
            listBtn.innerHTML = '‚è≥ R√©cup√©ration...';
            
            const startTime = Date.now();
            
            try {
                // R√©cup√©rer la liste des mod√®les disponibles
                const tagsResponse = await fetch('https://ollama.com/api/tags', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${cleanApiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!tagsResponse.ok) {
                    if (tagsResponse.status === 401) {
                        throw new Error('UNAUTHORIZED');
                    }
                    throw new Error(`HTTP ${tagsResponse.status}`);
                }
                
                const tagsData = await tagsResponse.json();
                const availableModels = (tagsData.models || []).map(m => {
                    // Retirer le suffixe :latest si pr√©sent
                    const name = m.name || '';
                    return name.replace(/:latest$/, '');
                });
                
                const elapsedTime = Date.now() - startTime;
                
                // Sauvegarder la liste des mod√®les dans localStorage pour persistance
                saveCloudModelsToStorage(availableModels);
                
                // Peupler le dropdown avec les mod√®les d√©couverts
                populateCloudModelDropdown(availableModels);
                
                // Afficher les mod√®les disponibles dans la zone d√©di√©e (cliquables)
                modelsResultDiv.style.background = 'rgba(139, 92, 246, 0.1)';
                modelsResultDiv.style.borderColor = 'rgba(139, 92, 246, 0.3)';
                modelsStatusDiv.innerHTML = `‚úÖ ${availableModels.length} mod√®le(s) disponible(s) (${elapsedTime}ms)`;
                modelsStatusDiv.style.color = '#059669';
                
                // R√©cup√©rer le mod√®le actuellement s√©lectionn√©
                const modelSelect = document.getElementById('configCloudModel');
                const modelCustom = document.getElementById('configCloudModelCustom');
                const currentModel = (modelSelect && modelSelect.value && modelSelect.value !== 'custom') 
                    ? modelSelect.value 
                    : (modelCustom && modelCustom.value ? modelCustom.value : null);
                
                const modelsList = availableModels.map(m => {
                    const isSelected = m === currentModel;
                    const modelClass = isSelected ? 'clickable-model selected' : 'clickable-model';
                    const indent = isSelected ? '' : '  ';
                    // √âchapper les guillemets simples pour √©viter les erreurs JavaScript
                    const escapedModel = m.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `${indent}<span class="${modelClass}" data-model="${escapedModel}" onclick="selectModelFromList('${escapedModel}')">${m}</span>`;
                }).join('<br>');
                modelsListDiv.innerHTML = modelsList;
                
            } catch (error) {
                const elapsedTime = Date.now() - startTime;
                modelsResultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                modelsResultDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                modelsStatusDiv.style.color = '#dc2626';
                
                if (error.message === 'UNAUTHORIZED') {
                    modelsStatusDiv.innerHTML = '‚ùå Non autoris√© (401)';
                    modelsListDiv.innerHTML = 'Cl√© API invalide ou expir√©e.<br>' +
                        '<a href="https://ollama.com/account" target="_blank" style="color: #667eea; text-decoration: underline;">Obtenez une nouvelle cl√© sur ollama.com/account</a>';
                } else {
                    modelsStatusDiv.innerHTML = `‚ùå Erreur (${elapsedTime}ms)`;
                    modelsListDiv.textContent = error.message || 'Erreur inconnue';
                }
            } finally {
                listBtn.disabled = false;
                listBtn.innerHTML = 'üìã Lister les mod√®les';
            }
        }
        
        // Fonction de test de connexion Ollama Cloud (liste + test chat)
        async function testOllamaCloudConnection() {
            const apiKeyField = document.getElementById('configCloudApiKey');
            let apiKey = apiKeyField.value.trim();
            
            // Si la cl√© contient des ast√©risques (masqu√©e), r√©cup√©rer la vraie cl√© depuis data-original-key
            if (apiKey && apiKey.includes('*')) {
                const originalKey = apiKeyField.getAttribute('data-original-key') || '';
                if (originalKey) {
                    apiKey = originalKey;
                }
            }
            
            const modelSelect = document.getElementById('configCloudModel');
            const modelCustom = document.getElementById('configCloudModelCustom');
            const model = (modelSelect && modelSelect.value && modelSelect.value !== 'custom') 
                ? modelSelect.value 
                : (modelCustom && modelCustom.value ? modelCustom.value : 'gpt-oss:120b');
            
            const modelsResultDiv = document.getElementById('cloudModelsResult');
            const modelsStatusDiv = document.getElementById('cloudModelsStatus');
            const modelsListDiv = document.getElementById('cloudModelsList');
            
            const resultDiv = document.getElementById('cloudTestResult');
            const statusDiv = document.getElementById('cloudTestStatus');
            const detailsDiv = document.getElementById('cloudTestDetails');
            const testBtn = document.getElementById('testCloudConnectionBtn');
            
            if (!apiKey) {
                modelsResultDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                resultDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                statusDiv.innerHTML = '‚ùå Cl√© API manquante';
                statusDiv.style.color = '#dc2626';
                detailsDiv.textContent = 'Veuillez entrer votre cl√© API Ollama Cloud';
                return;
            }
            
            // Nettoyer la cl√© API (supprimer espaces, caract√®res de contr√¥le)
            const cleanApiKey = apiKey.replace(/\s+/g, '').replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g, '');
            
            if (!cleanApiKey) {
                modelsResultDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                resultDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                statusDiv.innerHTML = '‚ùå Cl√© API invalide';
                statusDiv.style.color = '#dc2626';
                detailsDiv.textContent = 'La cl√© API ne peut pas √™tre vide apr√®s nettoyage';
                return;
            }
            
            // Afficher "Test en cours..."
            modelsResultDiv.style.display = 'block';
            modelsStatusDiv.innerHTML = '‚è≥ R√©cup√©ration des mod√®les disponibles...';
            modelsStatusDiv.style.color = '#7c3aed';
            modelsListDiv.textContent = '';
            
            resultDiv.style.display = 'block';
            resultDiv.style.background = 'rgba(59, 130, 246, 0.1)';
            resultDiv.style.borderColor = 'rgba(59, 130, 246, 0.3)';
            statusDiv.innerHTML = '‚è≥ Test de connexion en cours...';
            statusDiv.style.color = '#1e40af';
            detailsDiv.textContent = '';
            testBtn.disabled = true;
            testBtn.innerHTML = '‚è≥ Test en cours...';
            
            const startTime = Date.now();
            
            try {
                // √âtape 1: Lister les mod√®les disponibles
                const tagsResponse = await fetch('https://ollama.com/api/tags', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${cleanApiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!tagsResponse.ok) {
                    if (tagsResponse.status === 401) {
                        throw new Error('UNAUTHORIZED');
                    }
                    throw new Error(`HTTP ${tagsResponse.status}`);
                }
                
                const tagsData = await tagsResponse.json();
                const availableModels = (tagsData.models || []).map(m => {
                    // Retirer le suffixe :latest si pr√©sent
                    const name = m.name || '';
                    return name.replace(/:latest$/, '');
                });
                
                // Sauvegarder la liste des mod√®les dans localStorage pour persistance
                saveCloudModelsToStorage(availableModels);
                
                // Peupler le dropdown avec les mod√®les d√©couverts
                populateCloudModelDropdown(availableModels);
                
                // Afficher les mod√®les disponibles dans la zone d√©di√©e (cliquables)
                modelsStatusDiv.innerHTML = `‚úÖ ${availableModels.length} mod√®le(s) disponible(s)`;
                modelsStatusDiv.style.color = '#059669';
                
                const modelsList = availableModels.map(m => {
                    const isSelected = m === model;
                    const modelClass = isSelected ? 'clickable-model selected' : 'clickable-model';
                    const indent = isSelected ? '' : '  ';
                    // √âchapper les guillemets simples pour √©viter les erreurs JavaScript
                    const escapedModel = m.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `${indent}<span class="${modelClass}" data-model="${escapedModel}" onclick="selectModelFromList('${escapedModel}')">${m}</span>`;
                }).join('<br>');
                modelsListDiv.innerHTML = modelsList;
                
                // V√©rifier si le mod√®le demand√© est disponible
                const modelAvailable = availableModels.includes(model);
                
                if (!modelAvailable && availableModels.length > 0) {
                    detailsDiv.innerHTML = `‚ö†Ô∏è Le mod√®le "<strong>${model}</strong>" n'est pas disponible.<br>S√©lectionnez un mod√®le depuis la liste ci-dessus.`;
                }
                
                // √âtape 2: Tester une requ√™te chat
                detailsDiv.innerHTML += '<br>‚è≥ Test de la connexion chat...';
                
                const chatResponse = await fetch('https://ollama.com/api/chat', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${cleanApiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'system',
                                content: 'Tu es un assistant IA technique sp√©cialis√© dans le d√©veloppement logiciel, l\'architecture syst√®me et le support technique avanc√©. Tu fournis des r√©ponses pr√©cises, structur√©es et professionnelles. Tu utilises un vocabulaire technique appropri√© et des explications claires. Tu r√©ponds TOUJOURS exclusivement en fran√ßais. Tes r√©ponses sont concises mais compl√®tes, avec une attention particuli√®re √† la pr√©cision technique et √† l\'utilit√© pratique.'
                            },
                            {
                                role: 'user',
                                content: 'Confirme ta disponibilit√© en d√©crivant bri√®vement tes capacit√©s techniques actuelles (architecture, langages support√©s, m√©thodologies). R√©ponds en fran√ßais.'
                            }
                        ],
                        stream: false,
                        think: true
                    })
                });
                
                const elapsedTime = Date.now() - startTime;
                
                if (!chatResponse.ok) {
                    const errorBody = await chatResponse.text();
                    
                    if (chatResponse.status === 401) {
                        throw new Error('UNAUTHORIZED');
                    } else if (chatResponse.status === 400) {
                        throw new Error(`BAD_REQUEST: ${errorBody.substring(0, 200)}`);
                    } else if (chatResponse.status === 429) {
                        throw new Error('RATE_LIMIT');
                    } else if (chatResponse.status === 502 || chatResponse.status === 503) {
                        throw new Error(`QUOTA_ERROR: HTTP ${chatResponse.status}`);
                    }
                    
                    throw new Error(`HTTP ${chatResponse.status}: ${errorBody.substring(0, 200)}`);
                }
                
                const chatData = await chatResponse.json();
                const responseContent = chatData.message?.content || '';
                const thinking = chatData.message?.thinking || '';
                
                // Succ√®s!
                resultDiv.style.background = 'rgba(16, 185, 129, 0.1)';
                resultDiv.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                statusDiv.innerHTML = `‚úÖ Connexion OK (${elapsedTime}ms)`;
                statusDiv.style.color = '#059669';
                detailsDiv.innerHTML = `Mod√®le test√©: <strong>${model}</strong><br>` +
                    `R√©ponse: "<strong>${responseContent}</strong>"` +
                    (thinking ? `<br><small style="color: #64748b; margin-top: 4px; display: block;">üí≠ Thinking: ${thinking}</small>` : '');
                
                // Afficher le bouton "Voir plus" si le contenu d√©passe la hauteur max
                setTimeout(() => {
                    checkCloudTestExpand();
                }, 100);
                
            } catch (error) {
                const elapsedTime = Date.now() - startTime;
                
                // Si l'erreur survient lors de la r√©cup√©ration des mod√®les, masquer la zone mod√®les
                if (error.message === 'UNAUTHORIZED' || error.message.startsWith('HTTP')) {
                    modelsResultDiv.style.display = 'none';
                }
                
                resultDiv.style.background = 'rgba(239, 68, 68, 0.1)';
                resultDiv.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                statusDiv.style.color = '#dc2626';
                
                if (error.message === 'UNAUTHORIZED') {
                    statusDiv.innerHTML = '‚ùå Non autoris√© (401)';
                    detailsDiv.innerHTML = 'Cl√© API invalide ou expir√©e.<br>' +
                        '<a href="https://ollama.com/account" target="_blank" style="color: #667eea; text-decoration: underline;">Obtenez une nouvelle cl√© sur ollama.com/account</a>';
                } else if (error.message === 'RATE_LIMIT') {
                    statusDiv.innerHTML = '‚ö†Ô∏è Rate limit (429)';
                    detailsDiv.textContent = 'Trop de requ√™tes. Attendez quelques minutes avant de r√©essayer.';
                } else if (error.message.startsWith('QUOTA_ERROR')) {
                    statusDiv.innerHTML = '‚ö†Ô∏è Quota atteint';
                    detailsDiv.innerHTML = 'V√©rifiez votre quota sur <a href="https://ollama.com/account" target="_blank" style="color: #667eea; text-decoration: underline;">ollama.com/account</a>';
                } else if (error.message.startsWith('BAD_REQUEST')) {
                    statusDiv.innerHTML = '‚ùå Requ√™te invalide (400)';
                    detailsDiv.textContent = error.message.replace('BAD_REQUEST: ', '');
                } else {
                    statusDiv.innerHTML = `‚ùå Erreur (${elapsedTime}ms)`;
                    detailsDiv.textContent = error.message || 'Erreur inconnue';
                }
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = 'üß™ Tester la connexion';
                
                // Afficher le bouton "Voir plus" si n√©cessaire
                setTimeout(() => {
                    checkCloudTestExpand();
                }, 100);
            }
        }
        
        // Fonction pour v√©rifier si le contenu d√©passe et afficher "Voir plus"
        function checkCloudTestExpand() {
            const resultDiv = document.getElementById('cloudTestResult');
            const expandBtn = document.getElementById('cloudTestExpand');
            
            if (!resultDiv || !expandBtn) return;
            
            // V√©rifier si le contenu d√©passe la hauteur maximale
            if (resultDiv.scrollHeight > resultDiv.clientHeight) {
                expandBtn.style.display = 'block';
            } else {
                expandBtn.style.display = 'none';
            }
        }
        
        // Fonction pour d√©velopper/r√©duire la zone de diagnostic
        function expandCloudTestResult() {
            const resultDiv = document.getElementById('cloudTestResult');
            const expandBtn = document.getElementById('cloudTestExpand');
            
            if (!resultDiv || !expandBtn) return;
            
            if (resultDiv.style.maxHeight === 'none' || resultDiv.style.maxHeight === '') {
                // R√©duire
                resultDiv.style.maxHeight = '400px';
                expandBtn.innerHTML = '... Voir plus ...';
            } else {
                // D√©velopper
                resultDiv.style.maxHeight = 'none';
                expandBtn.innerHTML = '... R√©duire ...';
            }
        }
        
        // Fonction pour sauvegarder la liste des mod√®les dans localStorage
        function saveCloudModelsToStorage(models) {
            try {
                localStorage.setItem('ollama_cloud_models', JSON.stringify(models));
                localStorage.setItem('ollama_cloud_models_timestamp', Date.now().toString());
            } catch (e) {
                console.warn('Impossible de sauvegarder les mod√®les dans localStorage:', e);
            }
        }
        
        // Fonction pour charger la liste des mod√®les depuis localStorage
        function loadCloudModelsFromStorage() {
            try {
                const modelsJson = localStorage.getItem('ollama_cloud_models');
                const timestamp = localStorage.getItem('ollama_cloud_models_timestamp');
                
                if (modelsJson) {
                    const models = JSON.parse(modelsJson);
                    // V√©rifier que la liste n'est pas trop ancienne (max 7 jours)
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 jours en millisecondes
                    const age = timestamp ? Date.now() - parseInt(timestamp, 10) : Infinity;
                    
                    if (age < maxAge && Array.isArray(models) && models.length > 0) {
                        return models;
                    } else {
                        // Liste trop ancienne, la supprimer
                        localStorage.removeItem('ollama_cloud_models');
                        localStorage.removeItem('ollama_cloud_models_timestamp');
                    }
                }
            } catch (e) {
                console.warn('Impossible de charger les mod√®les depuis localStorage:', e);
            }
            return null;
        }
        
        // Fonction pour peupler le dropdown avec les mod√®les d√©couverts
        function populateCloudModelDropdown(models) {
            const dropdown = document.getElementById('configCloudModel');
            if (!dropdown) return;
            
            // Sauvegarder la valeur actuelle si elle existe
            const currentValue = dropdown.value;
            
            // Vider le dropdown (garder seulement "‚Äì Choisir ‚Äì" et "Autre (personnalis√©)")
            while (dropdown.children.length > 0) {
                dropdown.removeChild(dropdown.firstChild);
            }
            
            // Ajouter "‚Äì Choisir ‚Äì"
            const chooseOption = document.createElement('option');
            chooseOption.value = '';
            chooseOption.textContent = '‚Äì Choisir ‚Äì';
            dropdown.appendChild(chooseOption);
            
            // Ajouter tous les mod√®les d√©couverts
            models.forEach(modelName => {
                const option = document.createElement('option');
                option.value = modelName;
                // Formater le nom pour l'affichage (premi√®re lettre en majuscule, etc.)
                const displayName = modelName
                    .split(':')[0]
                    .split('-')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                option.textContent = displayName;
                dropdown.appendChild(option);
            });
            
            // Ajouter "Autre (personnalis√©)"
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = 'Autre (personnalis√©)';
            dropdown.appendChild(customOption);
            
            // Restaurer la valeur si elle existe encore dans la liste
            if (currentValue && models.includes(currentValue)) {
                dropdown.value = currentValue;
            } else if (currentValue === 'custom') {
                dropdown.value = 'custom';
            }
        }
        
        // Fonction pour s√©lectionner un mod√®le depuis la liste
        function selectModelFromList(modelName) {
            const dropdown = document.getElementById('configCloudModel');
            const customInput = document.getElementById('configCloudModelCustom');
            
            if (!dropdown) return;
            
            // D√©s√©chapper le nom du mod√®le (si n√©cessaire)
            const unescapedModelName = modelName.replace(/\\'/g, "'").replace(/&quot;/g, '"');
            
            // V√©rifier si le mod√®le est dans le dropdown
            const option = Array.from(dropdown.options).find(opt => opt.value === unescapedModelName);
            
            if (option) {
                // S√©lectionner dans le dropdown
                dropdown.value = unescapedModelName;
                
                // Masquer l'input personnalis√© si n√©cessaire
                if (customInput && !customInput.classList.contains('hidden')) {
                    customInput.classList.add('hidden');
                    customInput.value = '';
                }
                
                // D√©clencher l'√©v√©nement change pour mettre √† jour l'UI
                dropdown.dispatchEvent(new Event('change'));
            } else {
                // Mod√®le non dans le dropdown - utiliser l'input personnalis√©
                dropdown.value = 'custom';
                
                if (customInput) {
                    customInput.value = unescapedModelName;
                    customInput.classList.remove('hidden');
                    customInput.focus();
                }
                
                // D√©clencher l'√©v√©nement change pour mettre √† jour l'UI
                dropdown.dispatchEvent(new Event('change'));
            }
            
            // Mettre √† jour le style dans la liste (re-s√©lection)
            const modelsListDiv = document.getElementById('cloudModelsList');
            if (modelsListDiv) {
                const allSpans = modelsListDiv.querySelectorAll('.clickable-model');
                allSpans.forEach(span => {
                    const spanModel = span.getAttribute('data-model');
                    if (spanModel === modelName || spanModel === unescapedModelName) {
                        span.classList.add('selected');
                    } else {
                        span.classList.remove('selected');
                    }
                });
            }
        }
    </script>
</body>
</html>